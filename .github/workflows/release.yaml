name: Release

on:
  push:
    branches:
      - master
    paths:
      - 'gradle.properties'

permissions:
  contents: write

jobs:
  check-version-bump:
    name: Check Version Bump
    runs-on: ubuntu-24.04
    outputs:
      should_release: ${{ steps.version.outputs.changed }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: version
        run: |
          CURRENT=$(grep "voidstream.version=" gradle.properties | cut -d'=' -f2)
          git checkout HEAD~1 2>/dev/null || true
          PREVIOUS=$(grep "voidstream.version=" gradle.properties | cut -d'=' -f2 || echo "0.0.0")
          git checkout -

          echo "Current version: $CURRENT"
          echo "Previous version: $PREVIOUS"

          if [ "$CURRENT" != "$PREVIOUS" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "version=$CURRENT" >> "$GITHUB_OUTPUT"
            echo "Version changed from $PREVIOUS to $CURRENT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No version change detected"
          fi

  build-release-apks:
    name: Build ${{ matrix.flavor }} APK
    needs: check-version-bump
    if: needs.check-version-bump.outputs.should_release == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        flavor: [github, amazon, googleplay]
        include:
          - flavor: github
            artifact_name: voidstream-androidtv-github
            build_aab: false
          - flavor: amazon
            artifact_name: voidstream-androidtv-amazon
            build_aab: false
          - flavor: googleplay
            artifact_name: voidstream-androidtv-googleplay
            build_aab: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Android
        uses: ./.github/actions/setup-android

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "ERROR: RELEASE_KEYSTORE_BASE64 secret is not set"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 -d > release.keystore
          echo "‚úì Keystore decoded"

      - name: Create keystore.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ]; then
            echo "ERROR: One or more keystore secrets are not set"
            exit 1
          fi

          cat > keystore.properties <<EOF
          storeFile=$(pwd)/release.keystore
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF

          echo "‚úì keystore.properties created"

      - name: Run unit tests
        run: |
          FLAVOR_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${matrix.flavor:0:1})${matrix.flavor:1}"
          ./gradlew test${FLAVOR_CAP}ReleaseUnitTest \
            --parallel \
            --build-cache \
            --configuration-cache
        env:
          GRADLE_OPTS: -Xmx4096m -XX:MaxMetaspaceSize=1g

      - name: Build APK
        run: |
          FLAVOR_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${matrix.flavor:0:1})${matrix.flavor:1}"
          echo "Building ${FLAVOR_CAP}Release APK..."
          ./gradlew assemble${FLAVOR_CAP}Release \
            --parallel \
            --build-cache \
            --configuration-cache \
            --stacktrace
        env:
          GRADLE_OPTS: -Xmx4096m -XX:MaxMetaspaceSize=1g

      - name: Build AAB (Google Play only)
        if: matrix.build_aab
        run: |
          FLAVOR_CAP="$(tr '[:lower:]' '[:upper:]' <<< ${matrix.flavor:0:1})${matrix.flavor:1}"
          echo "Building ${FLAVOR_CAP}Release AAB..."
          ./gradlew bundle${FLAVOR_CAP}Release \
            --parallel \
            --build-cache \
            --configuration-cache \
            --stacktrace
        env:
          GRADLE_OPTS: -Xmx4096m -XX:MaxMetaspaceSize=1g

      - name: Verify APK signature
        run: |
          APK_PATH=$(find app/build/outputs/apk/${{ matrix.flavor }}/release -name "*.apk" -type f | head -n 1)
          echo "Verifying: $APK_PATH"

          if ! jarsigner -verify -verbose -certs "$APK_PATH" | grep -q "jar verified"; then
            echo "‚ùå Signature verification failed"
            exit 1
          fi

          echo "‚úì APK signature verified"

      - name: Generate checksums
        run: |
          # APK checksums
          cd app/build/outputs/apk/${{ matrix.flavor }}/release
          for file in *.apk; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256"
              echo "‚úì Checksum for $file:"
              cat "$file.sha256"
            fi
          done

          # AAB checksums (Google Play only)
          if [ "${{ matrix.build_aab }}" = "true" ]; then
            cd ../../../../bundle/${{ matrix.flavor }}Release
            for file in *.aab; do
              if [ -f "$file" ]; then
                sha256sum "$file" > "$file.sha256"
                echo "‚úì Checksum for $file:"
                cat "$file.sha256"
              fi
            done
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ matrix.artifact_name }}-apk
          path: |
            app/build/outputs/apk/${{ matrix.flavor }}/release/*.apk
            app/build/outputs/apk/${{ matrix.flavor }}/release/*.sha256
          retention-days: 90
          if-no-files-found: error

      - name: Upload AAB artifact (Google Play only)
        if: matrix.build_aab
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ matrix.artifact_name }}-aab
          path: |
            app/build/outputs/bundle/${{ matrix.flavor }}Release/*.aab
            app/build/outputs/bundle/${{ matrix.flavor }}Release/*.sha256
          retention-days: 90
          if-no-files-found: error

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results-${{ matrix.flavor }}
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          retention-days: 14
          if-no-files-found: ignore

  validate-amazon:
    name: Validate Amazon Compliance
    needs: build-release-apks
    runs-on: ubuntu-24.04

    steps:
      - name: Download Amazon APK
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: voidstream-androidtv-amazon-apk

      - name: Check for prohibited permissions
        run: |
          APK=$(find . -name "*.apk" -type f | head -n 1)
          echo "Checking: $APK"

          if aapt dump permissions "$APK" | grep -q "REQUEST_INSTALL_PACKAGES"; then
            echo "‚ùå FAIL: REQUEST_INSTALL_PACKAGES found"
            exit 1
          fi

          echo "‚úì PASS: No prohibited permissions"

      - name: Check for FileProvider
        run: |
          APK=$(find . -name "*.apk" -type f | head -n 1)

          if aapt dump xmltree "$APK" AndroidManifest.xml | grep -qi "FileProvider"; then
            echo "‚ùå FAIL: FileProvider found"
            exit 1
          fi

          echo "‚úì PASS: No FileProvider"

  validate-googleplay:
    name: Validate Google Play Compliance
    needs: build-release-apks
    runs-on: ubuntu-24.04

    steps:
      - name: Download Google Play APK
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: voidstream-androidtv-googleplay-apk

      - name: Check for prohibited permissions
        run: |
          APK=$(find . -name "*.apk" -type f | head -n 1)
          echo "Checking: $APK"

          if aapt dump permissions "$APK" | grep -q "REQUEST_INSTALL_PACKAGES"; then
            echo "‚ùå FAIL: REQUEST_INSTALL_PACKAGES found"
            exit 1
          fi

          echo "‚úì PASS: No prohibited permissions"

      - name: Check for FileProvider
        run: |
          APK=$(find . -name "*.apk" -type f | head -n 1)

          if aapt dump xmltree "$APK" AndroidManifest.xml | grep -qi "FileProvider"; then
            echo "‚ùå FAIL: FileProvider found"
            exit 1
          fi

          echo "‚úì PASS: No FileProvider"

  create-github-release:
    name: Create GitHub Release
    needs: [check-version-bump, build-release-apks, validate-amazon, validate-googleplay]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: artifacts

      - name: Check if pre-release
        id: prerelease
        run: |
          VERSION="${{ needs.check-version-bump.outputs.version }}"
          if [[ "$VERSION" =~ -(alpha|beta|rc) ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
            echo "Pre-release version detected: $VERSION"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
            echo "Stable release version: $VERSION"
          fi

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.check-version-bump.outputs.version }}"

          # Find last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -n "$LAST_TAG" ]; then
            echo "Generating changelog from $LAST_TAG to HEAD"
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges | grep -v "Update README version badges" | grep -v "\[skip ci\]" || echo "- Initial release")
          else
            echo "No previous tag found, using recent commits"
            COMMITS=$(git log --pretty=format:"- %s" --no-merges | head -20 | grep -v "Update README version badges" | grep -v "\[skip ci\]")
          fi

          # Build release notes
          {
            echo "notes<<EOF"
            echo "# VoidStream v${VERSION}"
            echo ""
            echo "## Changes"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "## Downloads"
            echo ""
            echo "### üì± GitHub (Sideloaded) Build"
            echo "- ‚úÖ Includes OTA self-update system"
            echo "- ‚úÖ Includes donate button"
            echo "- üì∫ For Fire TV, Android TV, Nvidia Shield"
            echo ""
            echo "**APK:** \`voidstream-androidtv-v${VERSION}-github-release.apk\`"
            echo ""
            echo "### üõí Amazon Appstore Build"
            echo "- ‚õî No OTA updates (managed by Amazon)"
            echo "- ‚õî No donate button"
            echo "- ‚úÖ Store compliance validated"
            echo ""
            echo "**APK:** \`voidstream-androidtv-v${VERSION}-amazon-release.apk\`"
            echo ""
            echo "### üõí Google Play Store Build"
            echo "- ‚õî No OTA updates (managed by Google Play)"
            echo "- ‚õî No donate button"
            echo "- ‚úÖ Store compliance validated"
            echo "- üì¶ Includes both APK and AAB formats"
            echo ""
            echo "**APK:** \`voidstream-androidtv-v${VERSION}-googleplay-release.apk\`"
            echo "**AAB:** \`voidstream-androidtv-v${VERSION}-googleplay-release.aab\`"
            echo ""
            echo "## üîí Verification"
            echo ""
            echo "All APKs include SHA-256 checksums (\`.sha256\` files). Verify before installing:"
            echo ""
            echo "\`\`\`bash"
            echo "sha256sum -c voidstream-androidtv-v${VERSION}-github-release.apk.sha256"
            echo "\`\`\`"
            echo ""
            echo "## üìñ Installation"
            echo ""
            echo "See the [README](https://github.com/ToastyToast25/VoidStream-FireTV/blob/master/README.md) for installation instructions."
            echo ""
            echo "---"
            echo ""
            echo "ü§ñ Built automatically with GitHub Actions"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f \( -name "*.apk" -o -name "*.aab" -o -name "*.sha256" \)

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.check-version-bump.outputs.version }}"
          PRERELEASE_FLAG=""

          if [ "${{ steps.prerelease.outputs.is_prerelease }}" == "true" ]; then
            PRERELEASE_FLAG="--prerelease"
            echo "Creating pre-release v${VERSION}"
          else
            echo "Creating stable release v${VERSION}"
          fi

          gh release create "v${VERSION}" \
            --title "VoidStream v${VERSION}" \
            --notes "${{ steps.notes.outputs.notes }}" \
            $PRERELEASE_FLAG \
            artifacts/voidstream-androidtv-github-apk/*.apk \
            artifacts/voidstream-androidtv-github-apk/*.sha256 \
            artifacts/voidstream-androidtv-amazon-apk/*.apk \
            artifacts/voidstream-androidtv-amazon-apk/*.sha256 \
            artifacts/voidstream-androidtv-googleplay-apk/*.apk \
            artifacts/voidstream-androidtv-googleplay-apk/*.sha256 \
            artifacts/voidstream-androidtv-googleplay-aab/*.aab \
            artifacts/voidstream-androidtv-googleplay-aab/*.sha256

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Release v${{ needs.check-version-bump.outputs.version }} created successfully"
          echo "URL: https://github.com/ToastyToast25/VoidStream-FireTV/releases/tag/v${{ needs.check-version-bump.outputs.version }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Release creation failed"
          echo "Check workflow logs above for details"
